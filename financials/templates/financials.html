{% extends 'layout.html' %}
{% load static %}

{% block title %}
    Financials for {{ symbol }}
{% endblock %}

{% block body %}
<!-- Render JSON safely -->
{{ roic_list|json_script:"roic-data" }}
{{ pe_ratios|json_script:"pe-data" }}

<div class="container" style="max-width: 900px; margin: auto; padding: 20px;">
  <h1>Financials for {{ symbol }}</h1>

  <div>
    <h2>Key Metrics</h2>
    <ul class="list-group">
        <li class="list-group-item">
          Revenue Growth:
          <span class="{% if revenue_growth > 0 %}text-success{% else %}text-danger{% endif %}">
            {{ revenue_growth }}%
          </span>
        </li>
        <li class="list-group-item">
          Earnings Growth:
          <span class="{% if earnings_growth > 0 %}text-success{% else %}text-danger{% endif %}">
            {{ earnings_growth }}%
          </span>
        </li>
        <li class="list-group-item">
          Shares Change:
          <span class="{% if shares_change > 0 %}text-danger{% else %}text-success{% endif %}">
            {{ shares_change }}%
          </span>
        </li>
        <li class="list-group-item">
          Free Cashflow Growth:
          <span class="{% if free_cashflow_growth > 0 %}text-success{% else %}text-danger{% endif %}">
            {{ free_cashflow_growth }}%
          </span>
        </li>
    </ul>
  </div>

  <div style="margin-top: 40px;">
    <h2>Charts</h2>

    <canvas id="roicChart" width="400" height="200"></canvas>
    <canvas id="peChart" width="400" height="200" style="margin-top:30px;"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const roicData = JSON.parse(document.getElementById('roic-data').textContent);
  const peData = JSON.parse(document.getElementById('pe-data').textContent);

  new Chart(document.getElementById('roicChart'), {
    type: 'line',
    data: {
      labels: ['Year -4', 'Year -3', 'Year -2', 'Year -1', 'Latest'],
      datasets: [{
        label: 'ROIC (%)',
        data: roicData,
        borderColor: 'blue',
        backgroundColor: 'lightblue',
        fill: false,
        tension: 0.3
      }]
    },
  });

  new Chart(document.getElementById('peChart'), {
    type: 'bar',
    data: {
      labels: ['Year -4', 'Year -3', 'Year -2', 'Year -1', 'Latest'],
      datasets: [{
        label: 'P/E Ratio',
        data: peData,
        backgroundColor: peData.map(val => val > 0 ? 'green' : 'red')
      }]
    },
  });
</script>

<!-- Financial Statements -->
<div class="container py-5">
  <h1 class="mb-5 text-center">Financial Statements for {{ symbol }}</h1>

  <!-- Income Statement -->
  <div class="mb-5">
    <h2>Income Statement</h2>
    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            {% if income_reports %}
              {% for key in income_reports.0.keys %}
                <th>{{ key|title }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for report in income_reports %}
            <tr>
              {% for value in report.values %}
                <td>{{ value }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Balance Sheet -->
  <div class="mb-5">
    <h2>Balance Sheet</h2>
    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            {% if balance_reports %}
              {% for key in balance_reports.0.keys %}
                <th>{{ key|title }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for report in balance_reports %}
            <tr>
              {% for value in report.values %}
                <td>{{ value }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Cash Flow Statement -->
  <div class="mb-5">
    <h2>Cash Flow Statement</h2>
    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            {% if cashflow_reports %}
              {% for key in cashflow_reports.0.keys %}
                <th>{{ key|title }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for report in cashflow_reports %}
            <tr>
              {% for value in report.values %}
                <td>{{ value }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
